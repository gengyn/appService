<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qingzhou.app.client.dao.ContractDao">
	<!-- 根据合同ID查询合同详情 -->
      <select id="selectByCustomer" parameterType="map" resultType="Contract">
		select t1.FORMAL_CONTRACT_ID, --正式合同主键 
       t1.CONTRACT_NUM, --合同编号
       t1.CONTRACT_TYPE, --合同类型代码
       (SELECT dd.LIST_DICTIONARY_NAME
          FROM T_PUB_LISTDICTIONARY dd, T_PUB_DICTIONARY dm
         WHERE dd.DICTIONARY_ID = dm.DICTIONARY_ID
           AND dm.DICTIONARY_NO = 'ContractStatu'
           AND dd.LIST_DICTIONARY_VALUE = t1.CONTRACT_TYPE
           AND dm.BISINESS_ID = t1.bisiness_id) as CONTRACT_TYPE_NAME, --合同类型名称
       TO_CHAR(t1.FILL_DATE,'YYYY-MM-DD') as FILL_DATE, --填报日期
       TO_CHAR(t1.CONTRACTSIGNED_DATE,'YYYY-MM-DD') as CONTRACTSIGNED_DATE, --合同签订日期
       t1.CUSTOMER_ID, --客户ID
       t2.REG_NAME, --客户姓名
       t2.REG_FIRST_MOBILEPHONE as REG_PHONE, --客户手机
       t2.REG_VILLAGE_NAME, --小区名称
       t2.REG_CONSTRUCT_ADDRESS, --施工地址
       t2.REG_CUSTOMER_MGR, --客户经理代码
       t3.NAME as REG_CUSTOMER_MGR_NAME,--客户经理姓名
       t3.MOBILE as REG_CUSTOMER_MGR_MOBILE, --客户经理电话
       t2.REG_Project_Mgr, --工程项目经理代码
       t4.NAME as REG_Project_Mgr_name, --工程项目经理姓名
       t4.MOBILE as REG_Project_Mgr_mobile, --工程项目经理电话
       t2.REG_STYLIST, --设计师代码
       t5.NAME as REG_STYLIST_NAME, --设计师姓名
       t5.MOBILE as REG_STYLIST_mobile,--设计师电话
       t1.QUO_ID, --报价单ID
       t1.FACT_TOTALMONEY, --实际总金额
       t1.CONTRACT_SUM_PRICE, --报价总金额
       t1.CONTRACT_SUM_PRICE - t1.FACT_TOTALMONEY as FAVORABLE_PRICE, --优惠金额
       t1.BASE_ITEM_PRICE, --基础项目金额
       t1.MAIN_ITEM_PRICE, --主材项目金额
       t1.FINISH_ITEM_PRICE, --成品项目金额
       t1.DESIGN_FEE, --设计费
       t1.MANAGE_FEE, --管理费
       TO_CHAR(t1.CONTRACTBEGINDATE,'YYYY-MM-DD') as CONTRACTBEGINDATE, --合同开工日期
       TO_CHAR(t1.CONTRACTENDDATE,'YYYY-MM-DD') as CONTRACTENDDATE, --合同竣工日期
       t1.DATE_NUMBER,--工期
       t1.BISINESS_ID --企业ID
  from T_SAAS_CONTRACT_FORMAL   t1,
       T_SAAS_CUSTOMER_REGISTER t2,
       USER_BASE_INFO           t3,
       USER_BASE_INFO           t4,
       USER_BASE_INFO           t5
 where t1.CUSTOMER_ID = t2.REG_ID
   and t2.REG_CUSTOMER_MGR = t3.USER_ID(+)
   and t2.REG_Project_Mgr = t4.USER_ID(+)
   and t2.REG_STYLIST = t5.USER_ID(+)
   and t1.FORMAL_CONTRACT_ID = #{formal_contract_id}
    </select>
    <!-- 查询合同优惠详情 -->
    <select id="listContractDiscount" resultType="ContractDiscount" parameterType="map">
       
       select t1.DISCOUNT_ITEM, --优惠项目
       t1.DISCOUNT_TYPE, --优惠类型
       (select dd.LIST_DICTIONARY_NAME
          FROM T_PUB_LISTDICTIONARY dd, T_PUB_DICTIONARY dm
         WHERE dd.DICTIONARY_ID = dm.DICTIONARY_ID
           AND dm.DICTIONARY_NO = 'yhk'
           AND dd.LIST_DICTIONARY_VALUE = t1.DISCOUNT_TYPE
           AND dm.BISINESS_ID = #{bisiness_id}) as DISCOUNT_TYPE_NAME, --优惠类型名称
       t1.DISCOUNT_MODE, --优惠方式
       (SELECT dd.LIST_DICTIONARY_NAME
          FROM T_PUB_LISTDICTIONARY dd, T_PUB_DICTIONARY dm
         WHERE dd.DICTIONARY_ID = dm.DICTIONARY_ID
           AND dm.DICTIONARY_NO = 'yhkd'
           AND dd.LIST_DICTIONARY_VALUE = t1.DISCOUNT_MODE
           AND dm.BISINESS_ID = #{bisiness_id}) as DISCOUNT_MODE_NAME,
       t1.DISCOUNT_CONTENT, --优惠内容
       t1.ITEM_VALUE, --项目标价
       t1.ITEM_COST --项目成本
  from T_SAAS_CONTRACT_DISCOUNTDETAIL t1
 where t1.FORMAL_CONTRACT_ID = #{formal_contract_id}
 order by t1.ADD_TIME desc
       
    </select>	
</mapper>